<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football xG Model</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">xG Analytics</h1>
            <div class="space-x-4">
                <a href="#" class="hover:text-gray-200">Dashboard</a>
                <a href="#" class="hover:text-gray-200">Team</a>
                <a href="#" class="hover:text-gray-200">Players</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Match Input Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Shot Details</h2>
                <form id="shotForm" onsubmit="handleSubmit(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Shot Distance (meters)</label>
                            <input type="number" name="shot_distance" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Angle (degrees)</label>
                            <input type="number" name="angle" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Body Part</label>
                            <select name="body_part" class="w-full p-2 border rounded" required>
                                <option value="foot">Foot</option>
                                <option value="head">Head</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Calculate xG
                        </button>
                    </div>
                </form>
            </div>

            <!-- xG Display Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Shot xG Analysis</h2>
                <div class="space-y-4">
                    <div class="flex justify-center items-center p-4 bg-gray-50 rounded">
                        <div>
                            <p class="font-semibold">Best Model Prediction</p>
                            <p id="bestModelName" class="text-lg text-blue-600 text-center">-</p>
                            <p id="xgValue" class="text-4xl text-blue-600 text-center">-</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">All Model Predictions</h3>
                        <table class="min-w-full border">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-2 border text-left">Model</th>
                                    <th class="p-2 border text-left">xG Value</th>
                                </tr>
                            </thead>
                            <tbody id="modelComparisonBody">
                                <tr class="border">
                                    <td class="p-2 border">Random Forest</td>
                                    <td class="p-2 border" id="rf-value">-</td>
                                </tr>
                                <tr class="border">
                                    <td class="p-2 border">XGBoost</td>
                                    <td class="p-2 border" id="xgb-value">-</td>
                                </tr>
                                <tr class="border">
                                    <td class="p-2 border">Logistic Regression</td>
                                    <td class="p-2 border" id="lr-value">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="predictionStatus" class="text-center text-gray-600"></div>
                </div>
            </div>

            <!-- Historical Data Section -->
            <div class="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Shot History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-4 text-left">Distance</th>
                                <th class="p-4 text-left">Angle</th>
                                <th class="p-4 text-left">Body Part</th>
                                <th class="p-4 text-left">RF xG</th>
                                <th class="p-4 text-left">XGBoost xG</th>
                                <th class="p-4 text-left">LR xG</th>
                                <th class="p-4 text-left">Best Model</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Model Accuracy Section -->
            <div class="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Model Accuracy Information</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full border">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-2 border text-left">Model</th>
                                <th class="p-2 border text-left">Train Accuracy</th>
                                <th class="p-2 border text-left">Test Accuracy</th>
                                <th class="p-2 border text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="accuracyTableBody">
                            <tr class="border">
                                <td class="p-2 border">Random Forest</td>
                                <td class="p-2 border" id="rf-train">-</td>
                                <td class="p-2 border" id="rf-test">-</td>
                                <td class="p-2 border" id="rf-status">-</td>
                            </tr>
                            <tr class="border">
                                <td class="p-2 border">XGBoost</td>
                                <td class="p-2 border" id="xgb-train">-</td>
                                <td class="p-2 border" id="xgb-test">-</td>
                                <td class="p-2 border" id="xgb-status">-</td>
                            </tr>
                            <tr class="border">
                                <td class="p-2 border">Logistic Regression</td>
                                <td class="p-2 border" id="lr-train">-</td>
                                <td class="p-2 border" id="lr-test">-</td>
                                <td class="p-2 border" id="lr-status">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://127.0.0.1:5000';
        const history = [];
        let modelAccuracy = {
            'random_forest': { test_accuracy: 0 },
            'xgboost': { test_accuracy: 0 },
            'logistic_regression': { test_accuracy: 0 }
        };
        
        // Fetch model accuracy information if available
        async function fetchModelInfo() {
            try {
                const response = await fetch(`${API_URL}/model_info`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success' && result.metrics) {
                        modelAccuracy = result.metrics;
                        updateAccuracyTable();
                    }
                }
            } catch (error) {
                console.error('Could not fetch model info:', error);
            }
        }
        
        // Initialize by fetching model info
        fetchModelInfo();
        
        function updateAccuracyTable() {
    // Map model names to the correct shorthand IDs used in HTML
    const modelToId = {
        'random_forest': 'rf',
        'xgboost': 'xgb',
        'logistic_regression': 'lr'
    };
    
    // Update accuracy table with values from modelAccuracy
    for (const [model, metrics] of Object.entries(modelAccuracy)) {
        const shortName = modelToId[model];
        
        if (shortName && metrics.train_accuracy !== undefined) {
            document.getElementById(`${shortName}-train`).textContent = 
                metrics.train_accuracy.toFixed(4);
        }
        
        if (shortName && metrics.test_accuracy !== undefined) {
            document.getElementById(`${shortName}-test`).textContent = 
                metrics.test_accuracy.toFixed(4);
        }
        
        // Determine which model is currently the best
        if (shortName) {
            document.getElementById(`${shortName}-status`).textContent = 
                getBestModelName() === model ? 'Best Model' : '';
        }
    }
}
        
        function getBestModelName() {
            // Find model with highest test accuracy
            let bestModel = 'random_forest';
            let bestAccuracy = modelAccuracy.random_forest.test_accuracy || 0;
            
            if ((modelAccuracy.xgboost.test_accuracy || 0) > bestAccuracy) {
                bestModel = 'xgboost';
                bestAccuracy = modelAccuracy.xgboost.test_accuracy;
            }
            
            if ((modelAccuracy.logistic_regression.test_accuracy || 0) > bestAccuracy) {
                bestModel = 'logistic_regression';
            }
            
            return bestModel;
        }
        
        function getReadableModelName(modelKey) {
            const names = {
                'random_forest': 'Random Forest',
                'xgboost': 'XGBoost',
                'logistic_regression': 'Logistic Regression'
            };
            return names[modelKey] || modelKey;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const shotData = {
                shots: [{
                    shot_distance: parseFloat(formData.get('shot_distance')),
                    angle: parseFloat(formData.get('angle')),
                    body_part: formData.get('body_part')
                }]
            };

            // Update status
            document.getElementById('predictionStatus').textContent = 'Calculating...';

            try {
                const response = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(shotData)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Updated to handle multiple model predictions
                    const predictions = result.predictions;
                    
                    // Update individual model values
                    document.getElementById('rf-value').textContent = 
                        predictions.random_forest[0].toFixed(3);
                    document.getElementById('xgb-value').textContent = 
                        predictions.xgboost[0].toFixed(3);
                    document.getElementById('lr-value').textContent = 
                        predictions.logistic_regression[0].toFixed(3);
                    
                    // Determine best model and update main display
                    const bestModel = getBestModelName();
                    const bestModelValue = predictions[bestModel][0];
                    
                    document.getElementById('bestModelName').textContent = 
                        getReadableModelName(bestModel);
                    document.getElementById('xgValue').textContent = 
                        bestModelValue.toFixed(3);
                    
                    document.getElementById('predictionStatus').textContent = 'Prediction successful!';
                    
                    // Add to history with all model predictions
                    history.unshift({
                        ...shotData.shots[0],
                        rf_xg: predictions.random_forest[0],
                        xgb_xg: predictions.xgboost[0],
                        lr_xg: predictions.logistic_regression[0],
                        best_model: bestModel
                    });
                    updateHistory();
                } else {
                    document.getElementById('predictionStatus').textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                document.getElementById('predictionStatus').textContent = 'Error connecting to server';
                console.error('Error:', error);
            }
        }

        function updateHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = history.slice(0, 5).map(shot => `
                <tr class="border-t">
                    <td class="p-4">${shot.shot_distance}m</td>
                    <td class="p-4">${shot.angle}Â°</td>
                    <td class="p-4">${shot.body_part}</td>
                    <td class="p-4">${shot.rf_xg.toFixed(3)}</td>
                    <td class="p-4">${shot.xgb_xg.toFixed(3)}</td>
                    <td class="p-4">${shot.lr_xg.toFixed(3)}</td>
                    <td class="p-4">${getReadableModelName(shot.best_model)}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>